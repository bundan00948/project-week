<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Staff Panel – Macau Traffic Monitor</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js"></script>
    <style>
        *{margin: 0;padding: 0;box-sizing: border-box;font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif}
        body{background: linear-gradient(rgba(0, 0, 0, .8), rgba(0, 0, 0, .8)), url('https://img1.wsimg.com/isteam/getty/2154404610') no-repeat center center fixed;background-size: cover;color: #fff;min-height: 100vh;padding: 20px;overflow-x: hidden}
        .container{max-width: 1400px;margin: 0 auto}
        header{text-align: center;padding: 20px 0;margin-bottom: 20px;background: rgba(0, 0, 0, .6);border-radius: 15px;box-shadow: 0 8px 32px rgba(0, 0, 0, .3);backdrop-filter: blur(10px);border: 1px solid rgba(255, 255, 255, .18)}
        .logo-container{display: flex;align-items: center;justify-content: center;gap: 15px;margin-bottom: 10px}
        .logo{width: 80px;height: 80px;background: linear-gradient(45deg, #ffd700, #ff8c00);border-radius: 50%;display: flex;align-items: center;justify-content: center;box-shadow: 0 0 20px rgba(255, 215, 0, .5)}
        .logo i{font-size: 40px;color: #8b0000}
        h1{font-size: 2.8rem;text-shadow: 0 2px 4px rgba(0, 0, 0, .5);margin-bottom: 5px}
        .subtitle{font-size: 1.2rem;opacity: .9;max-width: 600px;margin: 0 auto 20px}
        .auth-section{background: rgba(255, 255, 255, .1);border-radius: 15px;padding: 25px;margin: 20px 0;box-shadow: 0 8px 32px rgba(0, 0, 0, .3);backdrop-filter: blur(10px);border: 1px solid rgba(255, 255, 255, .18);text-align: center}
        .auth-section h2{color: #ffd700;margin-bottom: 20px}
        .form-group{margin-bottom: 20px;text-align: left}
        .form-group label{display: block;margin-bottom: 8px;font-weight: bold}
        .form-group input, .form-group select, .form-group textarea{width: 100%;padding: 12px;border-radius: 8px;border: 1px solid rgba(255, 255, 255, .3);background: rgba(0, 0, 0, .3);color: #fff;font-size: 1rem}
        .btn{padding: 12px 25px;border-radius: 30px;border: none;background: #ffd700;color: #000;font-weight: bold;cursor: pointer;transition: all .3s ease;display: inline-flex;align-items: center;gap: 8px}
        .btn:hover{transform: translateY(-3px);box-shadow: 0 5px 15px rgba(0, 0, 0, .3)}
        .btn i{font-size: 1.2rem}
        .cameras-section, .news-section, .ip-ban-section, .visits-section{display: none}
        .section-title{color: #ffd700;margin: 25px 0 15px;display: flex;align-items: center;gap: 10px}
        .camera-grid, .news-grid, .ip-grid{display: grid;grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));gap: 20px;margin-top: 20px}
        .camera-card, .news-card, .ip-card{background: rgba(255, 255, 255, .1);border-radius: 15px;padding: 20px;box-shadow: 0 8px 32px rgba(0, 0, 0, .3);backdrop-filter: blur(10px);border: 1px solid rgba(255, 255, 255, .18);cursor: move;transition: transform .3s ease}
        .camera-card:hover, .news-card:hover, .ip-card:hover{transform: translateY(-5px);box-shadow: 0 12px 40px rgba(0, 0, 0, .4)}
        .modal{display: none;position: fixed;top: 0;left: 0;width: 100%;height: 100%;background: rgba(0, 0, 0, .8);z-index: 1000;align-items: center;justify-content: center}
        .modal-content{background: rgba(0, 0, 0, .9);border-radius: 15px;padding: 30px;width: 90%;max-width: 600px;box-shadow: 0 10px 30px rgba(0, 0, 0, .5);border: 1px solid rgba(255, 255, 255, .18);position: relative}
        .close-modal{position: absolute;top: 20px;right: 20px;font-size: 1.5rem;cursor: pointer;color: #ffd700}
        .notification{position: fixed;top: 20px;right: 20px;padding: 15px 25px;border-radius: 8px;background: rgba(0, 0, 0, .8);border-left: 4px solid #4dff4d;box-shadow: 0 5px 15px rgba(0, 0, 0, .3);z-index: 2000;display: none;animation: slideIn .3s ease}
        @keyframes slideIn{from{transform: translateX(100%);opacity: 0}to{transform: translateX(0);opacity: 1}}
        footer{text-align: center;padding: 20px;margin-top: 30px;font-size: .9rem;opacity: .8;background: rgba(0, 0, 0, .6);border-radius: 15px;box-shadow: 0 8px 32px rgba(0, 0, 0, .3);backdrop-filter: blur(10px);border: 1px solid rgba(255, 255, 255, .18)}
        
        /* Tabs styling */
        .tabs{display: flex;margin: 20px 0;border-bottom: 1px solid rgba(255, 255, 255, .2)}
        .tab{padding: 12px 24px;cursor: pointer;transition: all .3s ease;border-bottom: 3px solid transparent}
        .tab.active{border-bottom: 3px solid #ffd700;color: #ffd700}
        .tab:hover{background: rgba(255, 255, 255, .1)}
        
        /* Search container */
        .search-container{display: flex;gap: 10px;margin: 20px 0}
        .search-container input{flex: 1}
        
        /* Stats container */
        .stats-container{display: flex;gap: 20px;margin: 20px 0}
        .stat-card{background: rgba(255, 255, 255, .1);padding: 15px;border-radius: 10px;text-align: center;min-width: 150px}
        .stat-label{font-size: .9rem;opacity: .8;margin-bottom: 5px}
        .stat-value{font-size: 1.8rem;font-weight: bold;color: #ffd700}
        
        /* Form row */
        .form-row{display: grid;grid-template-columns: 1fr 1fr;gap: 15px}
        
        /* Suggestion list */
        .suggestion-list{position: absolute;top: 100%;left: 0;right: 0;background: rgba(0, 0, 0, .9);border: 1px solid rgba(255, 255, 255, .2);border-radius: 8px;max-height: 200px;overflow-y: auto;z-index: 100;display: none}
        .suggestion-item{padding: 10px;cursor: pointer;border-bottom: 1px solid rgba(255, 255, 255, .1)}
        .suggestion-item:hover{background: rgba(255, 215, 0, .2)}
        
        /* Status indicator */
        .status-indicator{display: inline-block;width: 12px;height: 12px;border-radius: 50%;margin-right: 8px}
        .status-connected{background: #4dff4d}
        .status-disconnected{background: #ff4d4d}
        
        /* Notification error */
        .notification.error{border-left-color: #ff4d4d}
        
        /* Camera actions */
        .camera-actions, .news-actions, .ip-actions{display: flex;gap: 10px;margin-top: 15px}
        
        /* News styling */
        .news-title{display: flex;align-items: center;gap: 10px;margin-bottom: 10px;font-weight: bold}
        .news-content{margin-bottom: 15px;opacity: .9}
        .news-details{margin-bottom: 15px}
        .news-meta{font-size: .85rem;opacity: .7;margin-bottom: 15px}
        .drag-handle{cursor: move}
        
        /* Drag and drop */
        .drag-over{border: 2px dashed #ffd700}
        .dragging{opacity: .5}
        
        /* Position warning */
        .position-warning{color: #ffd700;margin-top: 5px;font-size: .9rem;display: none}
        
        /* Buttons secondary and danger */
        .btn-secondary{background: rgba(255, 255, 255, .2);color: #fff}
        .btn-danger{background: #ff4d4d;color: #fff}
        .btn-danger:hover{background: #ff3333}
        
        /* Camera card improvements */
        .camera-header{display: flex;justify-content: space-between;align-items: center;margin-bottom: 15px}
        .camera-title{font-size: 1.2rem;font-weight: bold}
        .camera-id{font-size: .85rem;opacity: .7}
        .camera-location{display: flex;align-items: center;gap: 5px;margin: 10px 0;font-size: .9rem}
        .camera-position{display: inline-block;background: rgba(255, 215, 0, .2);padding: 3px 8px;border-radius: 10px;font-size: .85rem}
        .camera-iframe-container{margin: 15px 0;position: relative;padding-top: 56.25%}
        .camera-iframe{position: absolute;top: 0;left: 0;width: 100%;height: 100%;border-radius: 10px}
        .camera-actions{justify-content: space-between}
        
        /* IP Ban styling */
        .ip-grid{display: grid;grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));gap: 20px;margin-top: 20px}
        .ip-card{background: rgba(255, 255, 255, .1);border-radius: 15px;padding: 20px;box-shadow: 0 8px 32px rgba(0, 0, 0, .3);backdrop-filter: blur(10px);border: 1px solid rgba(255, 255, 255, .18)}
        .ip-header{display: flex;justify-content: space-between;align-items: center;margin-bottom: 15px}
        .ip-title{font-size: 1.2rem;font-weight: bold}
        .ip-details{margin: 10px 0}
        .ip-actions{display: flex;gap: 10px;margin-top: 15px}
        .ip-table{width: 100%;border-collapse: collapse;margin-top: 20px}
        .ip-table th, .ip-table td{padding: 12px;text-align: left;border-bottom: 1px solid rgba(255, 255, 255, .1)}
        .ip-table th{background: rgba(255, 215, 0, .2);font-weight: bold}
        .ip-table tr:hover{background: rgba(255, 255, 255, .05)}
        .unban-btn{background: #4dff4d;color: #000}
        .unban-btn:hover{background: #33cc33}
        
        /* Visits styling */
        .data-table{width: 100%;border-collapse: collapse;margin-top: 20px;background: rgba(0, 0, 0, 0.3);border-radius: 10px;overflow: hidden}
        .data-table th, .data-table td{padding: 12px;text-align: left;border-bottom: 1px solid rgba(255, 255, 255, 0.1)}
        .data-table th{background: rgba(255, 215, 0, 0.2);font-weight: bold}
        .data-table tr:hover{background: rgba(255, 255, 255, 0.05)}
        .ban-btn{background: #ff4d4d;color: #fff}
        .ban-btn:hover{background: #ff3333}
    </style>
</head>
<body>
    <div class="container">
        <header>
            <div class="logo-container">
                <div class="logo"><i class="fas fa-car"></i></div>
                <div><h1>Staff Panel</h1><p class="subtitle">Manage Live Camera Feeds and News for Macau Traffic Monitor</p></div>
            </div>
        </header>

        <div class="auth-section" id="authSection">
            <h2><i class="fas fa-lock"></i> Staff Login</h2>
            <div class="form-group"><label for="email">Email</label><input type="email" id="email" placeholder="Enter your staff email"></div>
            <div class="form-group"><label for="password">Password</label><input type="password" id="password" placeholder="Enter your password"></div>
            <button class="btn" id="loginBtn"><i class="fas fa-sign-in-alt"></i> Login</button>
            <p style="margin-top: 15px;color: #ffd700"><i class="fas fa-info-circle"></i> Get away and go lost if you're not staff</p>
        </div>

        <div class="cameras-section" id="camerasSection">
            <div style="display: flex;justify-content: space-between;align-items: center">
                <h2 class="section-title"><i class="fas fa-video"></i> Live Camera Management</h2>
                <div><span class="status-indicator" id="statusIndicator"></span><span id="statusText">Connected to Firebase</span></div>
            </div>

            <div class="tabs">
                <div class="tab active" data-tab="cameras">Cameras</div>
                <div class="tab" data-tab="news">News</div>
                <div class="tab" data-tab="ip-ban">IP Ban</div>
                <div class="tab" data-tab="visits">All Visits</div>
            </div>

            <div class="search-container"><input type="text" id="searchCamera" placeholder="Search camera by ID..."><button class="btn" id="searchBtn"><i class="fas fa-search"></i> Search</button></div>
            <div style="display: flex;gap: 15px;margin: 20px 0;flex-wrap: wrap">
                <button class="btn" id="addCameraBtn"><i class="fas fa-plus"></i> Add New Camera</button>
                <button class="btn btn-secondary" id="refreshBtn"><i class="fas fa-sync-alt"></i> Refresh Data</button>
                <button class="btn btn-danger" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
            <div class="stats-container"><div class="stat-card"><div class="stat-label">Total Cameras</div><div class="stat-value" id="totalCameras">0</div></div></div>
            <div class="camera-grid" id="cameraGrid"></div>
        </div>

        <div class="news-section" id="newsSection">
            <div style="display: flex;justify-content: space-between;align-items: center">
                <h2 class="section-title"><i class="fas fa-newspaper"></i> News Management</h2>
                <div><span class="status-indicator" id="newsStatusIndicator"></span><span id="newsStatusText">Connected to Firebase</span></div>
            </div>

            <div class="tabs">
                <div class="tab" data-tab="cameras">Cameras</div>
                <div class="tab active" data-tab="news">News</div>
                <div class="tab" data-tab="ip-ban">IP Ban</div>
                <div class="tab" data-tab="visits">All Visits</div>
            </div>

            <div class="search-container"><input type="text" id="searchNews" placeholder="Search news by ID..."><button class="btn" id="searchNewsBtn"><i class="fas fa-search"></i> Search</button></div>
            <div style="display: flex;gap: 15px;margin: 20px 0;flex-wrap: wrap">
                <button class="btn" id="addNewsBtn"><i class="fas fa-plus"></i> Add New News</button>
                <button class="btn btn-secondary" id="refreshNewsBtn"><i class="fas fa-sync-alt"></i> Refresh Data</button>
                <button class="btn btn-danger" id="logoutNewsBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
            <div class="stats-container"><div class="stat-card"><div class="stat-label">Total News Items</div><div class="stat-value" id="totalNews">0</div></div></div>
            <div class="news-grid" id="newsGrid"></div>
        </div>

        <div class="ip-ban-section" id="ipBanSection">
            <div style="display: flex;justify-content: space-between;align-items: center">
                <h2 class="section-title"><i class="fas fa-ban"></i> IP Ban Management</h2>
                <div><span class="status-indicator" id="ipBanStatusIndicator"></span><span id="ipBanStatusText">Connected to Firebase</span></div>
            </div>

            <div class="tabs">
                <div class="tab" data-tab="cameras">Cameras</div>
                <div class="tab" data-tab="news">News</div>
                <div class="tab active" data-tab="ip-ban">IP Ban</div>
                <div class="tab" data-tab="visits">All Visits</div>
            </div>

            <div style="display: flex;gap: 15px;margin: 20px 0;flex-wrap: wrap">
                <button class="btn" id="banIPBtn"><i class="fas fa-plus"></i> Ban New IP</button>
                <button class="btn btn-secondary" id="refreshIPBanBtn"><i class="fas fa-sync-alt"></i> Refresh Data</button>
                <button class="btn btn-danger" id="logoutIPBanBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-label">Banned IPs</div>
                    <div class="stat-value" id="totalBannedIPs">0</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Total Logins</div>
                    <div class="stat-value" id="totalLogins">0</div>
                </div>
            </div>
            
            <div id="ipBanContent">
                <h3 style="margin: 20px 0 10px;"><i class="fas fa-list"></i> Banned IP Addresses</h3>
                <div class="ip-grid" id="ipGrid"></div>
            </div>
            
            <div id="loginLogsContent" style="margin-top: 30px;">
                <h3 style="margin: 20px 0 10px;"><i class="fas fa-history"></i> Login Logs</h3>
                <table class="ip-table">
                    <thead>
                        <tr>
                            <th>IP Address</th>
                            <th>Email</th>
                            <th>Status</th>
                            <th>Timestamp</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="loginLogsTable">
                        <!-- Logs will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="visits-section" id="visitsSection">
            <div style="display: flex;justify-content: space-between;align-items: center">
                <h2 class="section-title"><i class="fas fa-globe"></i> All Visits</h2>
                <div><span class="status-indicator" id="visitsStatusIndicator"></span><span id="visitsStatusText">Connected to Firebase</span></div>
            </div>

            <div class="tabs">
                <div class="tab" data-tab="cameras">Cameras</div>
                <div class="tab" data-tab="news">News</div>
                <div class="tab" data-tab="ip-ban">IP Ban</div>
                <div class="tab active" data-tab="visits">All Visits</div>
            </div>

            <div style="display: flex;gap: 15px;margin: 20px 0;flex-wrap: wrap">
                <button class="btn btn-secondary" id="refreshVisitsBtn"><i class="fas fa-sync-alt"></i> Refresh Data</button>
                <button class="btn btn-danger" id="logoutVisitsBtn"><i class="fas fa-sign-out-alt"></i> Logout</button>
            </div>
            
            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-label">Total Visits</div>
                    <div class="stat-value" id="totalVisits">0</div>
                </div>
            </div>
            
            <div id="visitsContent">
                <h3 style="margin: 20px 0 10px;"><i class="fas fa-list"></i> Visit Records</h3>
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>IP Address</th>
                            <th>Timestamp</th>
                            <th>User Agent</th>
                            <th>Page</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="visitsTableBody">
                        <!-- Visits will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>

        <div class="modal" id="cameraModal">
            <div class="modal-content">
                <span class="close-modal" id="closeModal">×</span>
                <h2 id="modalTitle">Add New Camera</h2>
                <div class="form-group"><label for="cameraId">Camera ID</label><div style="position: relative"><input type="text" id="cameraId" placeholder="Unique identifier (e.g., camera-001)"><div class="suggestion-list" id="suggestionList"></div></div></div>
                <div class="form-row"><div class="form-group"><label for="englishTitle">English Title</label><input type="text" id="englishTitle" placeholder="Camera title in English"></div><div class="form-group"><label for="chineseTitle">Chinese Title</label><input type="text" id="chineseTitle" placeholder="Camera title in Chinese"></div></div>
                <div class="form-row"><div class="form-group"><label for="portugueseTitle">Portuguese Title</label><input type="text" id="portugueseTitle" placeholder="Camera title in Portuguese"></div><div class="form-group"><label for="japaneseTitle">Japanese Title</label><input type="text" id="japaneseTitle" placeholder="Camera title in Japanese"></div></div>
                <div class="form-group"><label for="embedUrl">Embed URL</label><input type="text" id="embedUrl" placeholder="Live stream URL (e.g., https://...)"></div>
                <div class="form-group"><label for="location">Location</label><select id="location" class="form-control"><option value="macau-city">Macau City</option><option value="taipa">Taipa</option><option value="bridges">Cross-Sea Bridges</option><option value="border">Border Crossings</option></select></div>
                <div class="form-group"><label for="position">Position</label><input type="number" id="position" class="position-input" min="1" placeholder="Position number"><div class="position-warning" id="positionWarning"></div></div>
                <div style="display: flex;gap: 15px;margin-top: 25px"><button class="btn" id="saveCameraBtn"><i class="fas fa-save"></i> Save Camera</button><button class="btn btn-secondary" id="cancelBtn"><i class="fas fa-times"></i> Cancel</button></div>
            </div>
        </div>

        <div class="modal" id="newsModal">
            <div class="modal-content">
                <span class="close-modal" id="closeNewsModal">×</span>
                <h2 id="newsModalTitle">Add New News</h2>
                
                <div class="form-group">
                    <label for="newsId">News ID</label>
                    <input type="text" id="newsId" placeholder="Unique identifier (e.g., news-001)">
                </div>
                
                <div class="form-group">
                    <label for="newsTitle">Title</label>
                    <input type="text" id="newsTitle" placeholder="News title">
                </div>
                
                <div class="form-group">
                    <label for="newsContent">Content</label>
                    <textarea id="newsContent" rows="5" placeholder="News content..."></textarea>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="newsCategory">Category</label>
                        <select id="newsCategory"> 
                            <option value="traffic">Traffic</option>
                            <option value="incident">Incident</option>
                            <option value="construction">Construction</option>
                            <option value="weather">Weather</option>
                            <option value="general">General</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="newsRow">Row</label>
                        <select id="newsRow">
                            <option value="1">Row 1</option>
                            <option value="2">Row 2</option>
                            <option value="3">Row 3</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="newsPosition">Position</label>
                    <input type="number" id="newsPosition" min="1" placeholder="Position number">
                </div>
                
                <div style="display: flex;gap: 15px;margin-top: 25px">
                    <button class="btn" id="saveNewsBtn"><i class="fas fa-save"></i> Save News</button>
                    <button class="btn btn-secondary" id="cancelNewsBtn"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </div>
        </div>

        <div class="modal" id="banIPModal">
            <div class="modal-content">
                <span class="close-modal" id="closeBanModal">×</span>
                <h2><i class="fas fa-ban"></i> Ban IP Address</h2>
                <div class="form-group">
                    <label for="ipAddress">IP Address</label>
                    <input type="text" id="ipAddress" placeholder="Enter IP address to ban">
                </div>
                <div class="form-group">
                    <label for="banReason">Reason (Optional)</label>
                    <textarea id="banReason" rows="3" placeholder="Reason for banning this IP..."></textarea>
                </div>
                <div style="display: flex;gap: 15px;margin-top: 25px">
                    <button class="btn" id="saveBanBtn"><i class="fas fa-save"></i> Ban IP</button>
                    <button class="btn btn-secondary" id="cancelBanBtn"><i class="fas fa-times"></i> Cancel</button>
                </div>
            </div>
        </div>

        <div class="notification" id="notification"><p id="notificationMessage">Operation completed successfully!</p></div>
        <footer><p>Macau Traffic Monitor Staff Panel © 2026</p><p>Data Source: Firebase Realtime Database</p></footer>
    </div>

    <script>
        // Fixed Firebase config - removed extra spaces in URLs
        const firebaseConfig = {
            apiKey: "AIzaSyB1_sJvG1u47J3K0K0K0K0K0K0K0K0K0K0",        
            authDomain: "macau-traffic-501cb.firebaseapp.com",        
            databaseURL: "https://macau-traffic-501cb-default-rtdb.firebaseio.com",        
            projectId: "macau-traffic-501cb",        
            storageBucket: "macau-traffic-501cb.appspot.com",        
            messagingSenderId: "123456789012",        
            appId: "1:123456789012:web:abcdef1234567890abcdef"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // DOM Elements
        const authSection = document.getElementById('authSection');
        const camerasSection = document.getElementById('camerasSection');
        const newsSection = document.getElementById('newsSection');
        const ipBanSection = document.getElementById('ipBanSection');
        const visitsSection = document.getElementById('visitsSection');
        const cameraGrid = document.getElementById('cameraGrid');
        const newsGrid = document.getElementById('newsGrid');
        const ipGrid = document.getElementById('ipGrid');
        const loginLogsTable = document.getElementById('loginLogsTable');
        const visitsTableBody = document.getElementById('visitsTableBody');
        const cameraModal = document.getElementById('cameraModal');
        const newsModal = document.getElementById('newsModal');
        const banIPModal = document.getElementById('banIPModal');
        const notification = document.getElementById('notification');
        const statusIndicator = document.getElementById('statusIndicator');
        const statusText = document.getElementById('statusText');
        const newsStatusIndicator = document.getElementById('newsStatusIndicator');
        const newsStatusText = document.getElementById('newsStatusText');
        const ipBanStatusIndicator = document.getElementById('ipBanStatusIndicator');
        const ipBanStatusText = document.getElementById('ipBanStatusText');
        const visitsStatusIndicator = document.getElementById('visitsStatusIndicator');
        const visitsStatusText = document.getElementById('visitsStatusText');
        const totalCamerasEl = document.getElementById('totalCameras');
        const totalNewsEl = document.getElementById('totalNews');
        const totalBannedIPsEl = document.getElementById('totalBannedIPs');
        const totalLoginsEl = document.getElementById('totalLogins');
        const totalVisitsEl = document.getElementById('totalVisits');

        // Buttons
        const loginBtn = document.getElementById('loginBtn');
        const addCameraBtn = document.getElementById('addCameraBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const saveCameraBtn = document.getElementById('saveCameraBtn');
        const cancelBtn = document.getElementById('cancelBtn');
        const closeModal = document.getElementById('closeModal');
        const searchBtn = document.getElementById('searchBtn');
        
        const addNewsBtn = document.getElementById('addNewsBtn');
        const refreshNewsBtn = document.getElementById('refreshNewsBtn');
        const logoutNewsBtn = document.getElementById('logoutNewsBtn');
        const saveNewsBtn = document.getElementById('saveNewsBtn');
        const cancelNewsBtn = document.getElementById('cancelNewsBtn');
        const closeNewsModal = document.getElementById('closeNewsModal');
        const searchNewsBtn = document.getElementById('searchNewsBtn');
        
        const banIPBtn = document.getElementById('banIPBtn');
        const refreshIPBanBtn = document.getElementById('refreshIPBanBtn');
        const logoutIPBanBtn = document.getElementById('logoutIPBanBtn');
        const saveBanBtn = document.getElementById('saveBanBtn');
        const cancelBanBtn = document.getElementById('cancelBanBtn');
        const closeBanModal = document.getElementById('closeBanModal');
        
        const refreshVisitsBtn = document.getElementById('refreshVisitsBtn');
        const logoutVisitsBtn = document.getElementById('logoutVisitsBtn');

        // Camera Form Elements
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');
        const cameraIdInput = document.getElementById('cameraId');
        const englishTitleInput = document.getElementById('englishTitle');
        const chineseTitleInput = document.getElementById('chineseTitle');
        const portugueseTitleInput = document.getElementById('portugueseTitle');
        const japaneseTitleInput = document.getElementById('japaneseTitle');
        const embedUrlInput = document.getElementById('embedUrl');
        const locationSelect = document.getElementById('location');
        const positionInput = document.getElementById('position');
        const searchCameraInput = document.getElementById('searchCamera');
        const positionWarning = document.getElementById('positionWarning');
        const suggestionList = document.getElementById('suggestionList');

        // News Form Elements
        const newsIdInput = document.getElementById('newsId');
        const newsTitleInput = document.getElementById('newsTitle');
        const newsContentInput = document.getElementById('newsContent');
        const newsCategorySelect = document.getElementById('newsCategory');
        const newsRowSelect = document.getElementById('newsRow');
        const newsPositionInput = document.getElementById('newsPosition');
        const searchNewsInput = document.getElementById('searchNews');

        // IP Ban Form Elements
        const ipAddressInput = document.getElementById('ipAddress');
        const banReasonInput = document.getElementById('banReason');

        // State variables
        let currentEditingCameraId = null;
        let currentEditingNewsId = null;
        let isAuthenticated = false;
        let allCameras = {};
        let allNews = {};
        let bannedIPs = {};
        let loginLogs = {};
        let allVisits = {};
        let draggedItem = null;

        // Initialize the application
        function init(){
            updateConnectionStatus(true);
            loadCameras();
            loadNews();
            
            // Add event listeners for tabs
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const tabType = tab.getAttribute('data-tab');
                    
                    // Update active tab
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    
                    // Show/hide sections
                    if(tabType === 'cameras') {
                        camerasSection.style.display = 'block';
                        newsSection.style.display = 'none';
                        ipBanSection.style.display = 'none';
                        visitsSection.style.display = 'none';
                    } else if(tabType === 'news') {
                        camerasSection.style.display = 'none';
                        newsSection.style.display = 'block';
                        ipBanSection.style.display = 'none';
                        visitsSection.style.display = 'none';
                    } else if(tabType === 'ip-ban') {
                        camerasSection.style.display = 'none';
                        newsSection.style.display = 'none';
                        ipBanSection.style.display = 'block';
                        visitsSection.style.display = 'none';
                        loadBannedIPs();
                        loadLoginLogs();
                    } else if(tabType === 'visits') {
                        camerasSection.style.display = 'none';
                        newsSection.style.display = 'none';
                        ipBanSection.style.display = 'none';
                        visitsSection.style.display = 'block';
                        loadAllVisits();
                    }
                });
            });
            
            // Camera form event listeners
            locationSelect.addEventListener('change', updatePositionExample);
            positionInput.addEventListener('input', validatePosition);
            cameraIdInput.addEventListener('input', showSuggestions);
            document.addEventListener('click', e => {
                if(!e.target.closest('#cameraId')) suggestionList.style.display = 'none';
            });
        }

        // Show suggestions for camera IDs
        function showSuggestions(){
            const input = cameraIdInput.value.toLowerCase();
            suggestionList.innerHTML = '';
            if(input.length < 2){suggestionList.style.display = 'none'; return}
            const suggestions = Object.keys(allCameras).filter(id => id.toLowerCase().includes(input)).slice(0, 5);
            if(suggestions.length > 0){
                suggestions.forEach(id => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = id;
                    item.addEventListener('click', () => {
                        cameraIdInput.value = id;
                        suggestionList.style.display = 'none';
                        fillFormWithCameraData(id);
                    });
                    suggestionList.appendChild(item);
                });
                suggestionList.style.display = 'block';
            }else{
                suggestionList.style.display = 'none';
            }
        }

        // Fill camera form with existing data
        function fillFormWithCameraData(cameraId){
            const camera = allCameras[cameraId];
            if(camera){
                englishTitleInput.value = camera.titles.en || '';
                chineseTitleInput.value = camera.titles.zh || '';
                portugueseTitleInput.value = camera.titles.pt || '';
                japaneseTitleInput.value = camera.titles.ja || '';
                embedUrlInput.value = camera.embedUrl || '';
                locationSelect.value = camera.location || 'macau-city';
                positionInput.value = camera.position || '';
                updatePositionExample();
                validatePosition();
            }
        }

        // Update position example text
        function updatePositionExample(){
            const locationText = locationSelect.options[locationSelect.selectedIndex].text;
            // Fixed: removed reference to non-existent element
        }

        // Validate camera position
        function validatePosition(){
            const position = positionInput.value.trim();
            const location = locationSelect.value;
            if(!position){positionWarning.style.display = 'none'; return}
            const positionNum = parseInt(position);
            let conflictCameraId = null;
            Object.keys(allCameras).forEach(cameraId => {
                const camera = allCameras[cameraId];
                if(camera.location === location && camera.position === positionNum && cameraId !== currentEditingCameraId)
                    conflictCameraId = cameraId;
            });
            if(conflictCameraId){
                positionWarning.textContent = `Position ${positionNum} is already occupied by camera ID: ${conflictCameraId}. Saving will move that camera to the back.`;
                positionWarning.style.display = 'block';
            }else{
                positionWarning.style.display = 'none';
            }
        }

        // Update connection status indicator
        function updateConnectionStatus(connected){
            statusIndicator.className = connected ? 'status-indicator status-connected' : 'status-indicator status-disconnected';
            statusText.textContent = connected ? 'Connected to Firebase' : 'Disconnected from Firebase';
            newsStatusIndicator.className = connected ? 'status-indicator status-connected' : 'status-indicator status-disconnected';
            newsStatusText.textContent = connected ? 'Connected to Firebase' : 'Disconnected from Firebase';
            ipBanStatusIndicator.className = connected ? 'status-indicator status-connected' : 'status-indicator status-disconnected';
            ipBanStatusText.textContent = connected ? 'Connected to Firebase' : 'Disconnected from Firebase';
            visitsStatusIndicator.className = connected ? 'status-indicator status-connected' : 'status-indicator status-disconnected';
            visitsStatusText.textContent = connected ? 'Connected to Firebase' : 'Disconnected from Firebase';
        }

        // Show notification message
        function showNotification(message, isError = false){
            document.getElementById('notificationMessage').textContent = message;
            notification.className = isError ? 'notification error' : 'notification';
            notification.style.display = 'block';
            setTimeout(() => notification.style.display = 'none', 3000);
        }

        // Login function - FIXED VERSION
        function login(){
            const email = emailInput.value.trim();
            const password = passwordInput.value.trim();
            
            if(!email || !password){
                showNotification('Please enter both email and password', true);
                return;
            }
            
            // Simple authentication check (in real app, this would be server-side)
            if(email === 'admin@macautraffic.com' && password === 'Admin123'){
                isAuthenticated = true;
                
                // Hide auth section and show cameras section
                authSection.style.display = 'none';
                camerasSection.style.display = 'block';
                
                showNotification('Login successful!');
            }else{
                showNotification('Invalid credentials. Please try again.', true);
            }
        }

        // Logout function
        function logout(){
            isAuthenticated = false;
            camerasSection.style.display = 'none';
            newsSection.style.display = 'none';
            ipBanSection.style.display = 'none';
            visitsSection.style.display = 'none';
            authSection.style.display = 'block';
            emailInput.value = '';
            passwordInput.value = '';
            showNotification('You have been logged out');
        }

        // Search camera function
        function searchCamera(){
            const searchTerm = searchCameraInput.value.trim().toLowerCase();
            if(!searchTerm){
                showNotification('Please enter a camera ID to search', true);
                return;
            }
            const foundCameraId = Object.keys(allCameras).find(id => id.toLowerCase().includes(searchTerm));
            if(foundCameraId){
                editCamera(foundCameraId);
            } else {
                showNotification('Camera not found', true);
            }
        }

        // Search news function
        function searchNews(){
            const searchTerm = searchNewsInput.value.trim().toLowerCase();
            if(!searchTerm){
                showNotification('Please enter a news ID to search', true);
                return;
            }
            const foundNewsId = Object.keys(allNews).find(id => id.toLowerCase().includes(searchTerm));
            if(foundNewsId){
                editNews(foundNewsId);
            } else {
                showNotification('News item not found', true);
            }
        }

        // Load cameras from Firebase
        function loadCameras(){
            cameraGrid.innerHTML = '<p style="text-align: center;width: 100%"><i class="fas fa-spinner fa-spin"></i> Loading cameras...</p>';
            database.ref('cameras').once('value').then(snapshot => {
                const cameras = snapshot.val();
                if(cameras){
                    allCameras = cameras;
                    displayCameras(cameras);
                    updateCameraStats();
                } else {
                    cameraGrid.innerHTML = '<p style="text-align: center;width: 100%">No cameras found</p>';
                    allCameras = {};
                    updateCameraStats();
                }
            }).catch(err => {
                console.error(err);
                cameraGrid.innerHTML = '<p style="text-align: center;width: 100%;color: #ff4d4d">Error loading cameras.</p>';
                showNotification('Failed to load cameras', true);
            });
        }

        // Load news from Firebase
        function loadNews(){
            newsGrid.innerHTML = '<p style="text-align: center;width: 100%"><i class="fas fa-spinner fa-spin"></i> Loading news...</p>';
            database.ref('news').once('value').then(snapshot => {
                const news = snapshot.val();
                if(news){
                    allNews = news;
                    displayNews(news);
                    updateNewsStats();
                } else {
                    newsGrid.innerHTML = '<p style="text-align: center;width: 100%">No news found</p>';
                    allNews = {};
                    updateNewsStats();
                }
            }).catch(err => {
                console.error(err);
                newsGrid.innerHTML = '<p style="text-align: center;width: 100%;color: #ff4d4d">Error loading news.</p>';
                showNotification('Failed to load news', true);
            });
        }

        // Load banned IPs from Firebase
        function loadBannedIPs(){
            ipGrid.innerHTML = '<p style="text-align: center;width: 100%"><i class="fas fa-spinner fa-spin"></i> Loading banned IPs...</p>';
            database.ref('banned_ips').once('value').then(snapshot => {
                const ips = snapshot.val();
                if(ips){
                    bannedIPs = ips;
                    displayBannedIPs(ips);
                    updateIPStats();
                } else {
                    ipGrid.innerHTML = '<p style="text-align: center;width: 100%">No banned IPs found</p>';
                    bannedIPs = {};
                    updateIPStats();
                }
            }).catch(err => {
                console.error(err);
                ipGrid.innerHTML = '<p style="text-align: center;width: 100%;color: #ff4d4d">Error loading banned IPs.</p>';
                showNotification('Failed to load banned IPs', true);
            });
        }

        // Load login logs from Firebase
        function loadLoginLogs(){
            loginLogsTable.innerHTML = '<tr><td colspan="5" style="text-align: center"><i class="fas fa-spinner fa-spin"></i> Loading login logs...</td></tr>';
            database.ref('login_logs').once('value').then(snapshot => {
                const logs = snapshot.val();
                if(logs){
                    loginLogs = logs;
                    displayLoginLogs(logs);
                    updateLogStats();
                } else {
                    loginLogsTable.innerHTML = '<tr><td colspan="5" style="text-align: center">No login logs found</td></tr>';
                    loginLogs = {};
                    updateLogStats();
                }
            }).catch(err => {
                console.error(err);
                loginLogsTable.innerHTML = '<tr><td colspan="5" style="text-align: center;color: #ff4d4d">Error loading login logs.</td></tr>';
                showNotification('Failed to load login logs', true);
            });
        }

        // Load all visits from Firebase
        function loadAllVisits(){
            visitsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center"><i class="fas fa-spinner fa-spin"></i> Loading visits...</td></tr>';
            database.ref('all_visits').once('value').then(snapshot => {
                const visits = snapshot.val();
                if(visits){
                    allVisits = visits;
                    displayVisits(visits);
                    updateVisitStats();
                } else {
                    visitsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center">No visits found</td></tr>';
                    allVisits = {};
                    updateVisitStats();
                }
            }).catch(err => {
                console.error(err);
                visitsTableBody.innerHTML = '<tr><td colspan="5" style="text-align: center;color: #ff4d4d">Error loading visits.</td></tr>';
                showNotification('Failed to load visits', true);
            });
        }

        // Update camera statistics
        function updateCameraStats(){
            totalCamerasEl.textContent = Object.keys(allCameras).length;
        }

        // Update news statistics
        function updateNewsStats(){
            totalNewsEl.textContent = Object.keys(allNews).length;
        }

        // Update IP statistics
        function updateIPStats(){
            totalBannedIPsEl.textContent = Object.keys(bannedIPs).length;
        }

        // Update login log statistics
        function updateLogStats(){
            totalLoginsEl.textContent = Object.keys(loginLogs).length;
        }

        // Update visit statistics
        function updateVisitStats(){
            totalVisitsEl.textContent = Object.keys(allVisits).length;
        }

        // Display cameras in the panel with improved formatting
        function displayCameras(cameras) {
            cameraGrid.innerHTML = '';
            const camerasArray = Object.keys(cameras).map(id => ({ id, ...cameras[id] }));

            // Sort cameras based on position
            camerasArray.sort((a, b) => {
                if (a.position == null) return 1; // Place cameras without position at the end
                if (b.position == null) return -1;
                return a.position - b.position; // Ascending order
            });

            camerasArray.forEach(camera => {
                const card = document.createElement('div');
                card.className = 'camera-card';
                card.setAttribute('data-id', camera.id);
                card.setAttribute('draggable', 'true');
                
                // Format location text
                const locationMap = {
                    'macau-city': 'Macau City',       
                    'taipa': 'Taipa',       
                    'bridges': 'Cross-Sea Bridges',       
                    'border': 'Border Crossings'
                };
                const locationText = locationMap[camera.location] || camera.location;
                
                card.innerHTML = `
                    <div class="camera-header">
                        <div>
                            <div class="camera-title">${camera.titles.en}</div>
                            <div class="camera-id">ID: ${camera.id}</div>
                        </div>
                        <div class="camera-position">Pos: ${camera.position || 'N/A'}</div>
                    </div>
                    <div class="camera-location">
                        <i class="fas fa-map-marker-alt"></i> ${locationText}
                    </div>
                    <div class="camera-iframe-container">
                        <iframe class="camera-iframe" src="${camera.embedUrl}" allowfullscreen></iframe>
                    </div>
                    <div class="camera-actions">
                        <button class="btn btn-secondary edit-btn" data-id="${camera.id}"><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn btn-danger delete-btn" data-id="${camera.id}"><i class="fas fa-trash"></i> Delete</button>
                    </div>`;
                cameraGrid.appendChild(card);
                
                // Add drag and drop event listeners
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('dragenter', handleDragEnter);
                card.addEventListener('dragleave', handleDragLeave);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragend', handleDragEnd);
            });

            document.querySelectorAll('.edit-btn').forEach(btn => 
                btn.addEventListener('click', () => editCamera(btn.dataset.id)));
            document.querySelectorAll('.delete-btn').forEach(btn => 
                btn.addEventListener('click', () => deleteCamera(btn.dataset.id)));
        }

        // Display news items
        function displayNews(news){
            newsGrid.innerHTML = '';
            const newsArray = Object.keys(news).map(id => ({id, ...news[id]}));
            newsArray.sort((a, b) => {
                if(a.position == null) return 1;
                if(b.position == null) return -1;
                return a.position - b.position;
            });
            newsArray.forEach(item => {
                const card = document.createElement('div');
                card.className = 'news-card';
                card.setAttribute('data-id', item.id);
                card.setAttribute('draggable', 'true');
                
                // Format date for display
                const date = new Date(item.date || Date.now());
                const formattedDate = date.toLocaleDateString();
                
                card.innerHTML = `
                    <div class="news-title"><i class="fas fa-grip-vertical drag-handle"></i><i class="fas fa-newspaper"></i> ${item.title}</div>
                    <div class="news-content">${item.content.substring(0, 150)}${item.content.length > 150 ? '...' : ''}</div>
                    <div class="news-details">
                        <p><strong>ID: </strong> ${item.id}</p>
                        <p><strong>Category: </strong> ${item.category}</p>
                        <p><strong>Row: </strong> ${item.row || 'Not set'}</p>
                        <p><strong>Position: </strong> ${item.position || 'Not set'}</p>
                    </div>
                    <div class="news-meta">
                        <span><i class="far fa-calendar"></i> ${formattedDate}</span>
                    </div>
                    <div class="news-actions">
                        <button class="btn btn-secondary edit-news-btn" data-id="${item.id}"><i class="fas fa-edit"></i> Edit</button>
                        <button class="btn btn-danger delete-news-btn" data-id="${item.id}"><i class="fas fa-trash"></i> Delete</button>
                    </div>`;
                newsGrid.appendChild(card);
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('dragenter', handleDragEnter);
                card.addEventListener('dragleave', handleDragLeave);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragend', handleDragEnd);
            });
            document.querySelectorAll('.edit-news-btn').forEach(btn => 
                btn.addEventListener('click', () => editNews(btn.dataset.id)));
            document.querySelectorAll('.delete-news-btn').forEach(btn => 
                btn.addEventListener('click', () => deleteNews(btn.dataset.id)));
        }

        // Display banned IPs with BAN ID as title and IP as sub-data
        function displayBannedIPs(ips) {
            ipGrid.innerHTML = '';
            const ipsArray = Object.keys(ips).map(banId => ({ banId, ...ips[banId] }));

            ipsArray.forEach(item => {
                const card = document.createElement('div');
                card.className = 'ip-card';
                card.setAttribute('data-banid', item.banId);
                card.setAttribute('draggable', 'true');
                
                // Format date for display
                const date = new Date(item.timestamp || Date.now());
                const formattedDate = date.toLocaleString();
                
                // Updated display format with BAN ID as title and IP as sub-data
                card.innerHTML = `
                    <div class="ip-header">
                        <div class="ip-title">BAN ID: ${item.banId}</div>
                    </div>
                    <div class="ip-details">
                        <p><strong>IP Address: </strong> ${item.ip}</p>
                        <p><strong>Timestamp: </strong> ${formattedDate}</p>
                        <p><strong>Reason: </strong> ${item.reason || 'Not specified'}</p>
                    </div>
                    <div class="ip-actions">
                        <button class="btn unban-btn" data-banid="${item.banId}"><i class="fas fa-check-circle"></i> Unban</button>
                    </div>`;
                ipGrid.appendChild(card);
                
                // Add drag and drop event listeners
                card.addEventListener('dragstart', handleDragStart);
                card.addEventListener('dragover', handleDragOver);
                card.addEventListener('dragenter', handleDragEnter);
                card.addEventListener('dragleave', handleDragLeave);
                card.addEventListener('drop', handleDrop);
                card.addEventListener('dragend', handleDragEnd);
            });

            document.querySelectorAll('.unban-btn').forEach(btn => 
                btn.addEventListener('click', () => unbanIP(btn.dataset.banid)));
        }

        // Display login logs
        function displayLoginLogs(logs){
            loginLogsTable.innerHTML = '';
            const logsArray = Object.keys(logs).map(id => ({ id, ...logs[id] }));
            
            // Sort by timestamp (newest first)
            logsArray.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            logsArray.forEach(log => {
                const row = document.createElement('tr');
                
                // Format date for display
                const date = new Date(log.timestamp);
                const formattedDate = date.toLocaleString();
                
                // Determine status
                const status = log.banned ? '<span style="color: #ff4d4d">Banned</span>' : (log.success ? '<span style="color: #4dff4d">Success</span>' : '<span style="color: #ff9900">Failed</span>');
                
                row.innerHTML = `
                    <td>${log.ip}</td>
                    <td>${log.email}</td>
                    <td>${status}</td>
                    <td>${formattedDate}</td>
                    <td>
                        ${log.banned ? 
                            `<button class="btn unban-btn" data-ip="${log.ip}" style="padding: 5px 10px;font-size: 0.9rem;">
                                <i class="fas fa-check-circle"></i> Unban
                            </button>` :    
                            `<button class="btn ban-btn" data-ip="${log.ip}" style="padding: 5px 10px;font-size: 0.9rem;">
                                <i class="fas fa-ban"></i> Ban
                            </button>`
                        }
                    </td>`;
                loginLogsTable.appendChild(row);
            });
            
            // Add event listeners for ban/unban buttons
            document.querySelectorAll('.unban-btn').forEach(btn => 
                btn.addEventListener('click', () => unbanIP(btn.dataset.ip)));
            document.querySelectorAll('.ban-btn').forEach(btn => 
                btn.addEventListener('click', () => banIPFromLog(btn.dataset.ip)));
        }

        // Display visits
        function displayVisits(visits) {
            visitsTableBody.innerHTML = '';
            const visitsArray = Object.keys(visits).map(id => ({ id, ...visits[id] }));
            
            // Sort by timestamp (newest first)
            visitsArray.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            visitsArray.forEach(visit => {
                const row = document.createElement('tr');
                
                // Format date for display
                const date = new Date(visit.timestamp);
                const formattedDate = date.toLocaleString();
                
                // Truncate long user agent
                const userAgent = visit.userAgent.length > 50 ? 
                    visit.userAgent.substring(0, 50) + '...' :    
                    visit.userAgent;
                
                row.innerHTML = `
                    <td>${visit.ip}</td>
                    <td>${formattedDate}</td>
                    <td>${userAgent}</td>
                    <td>${visit.page}</td>
                    <td>
                        <button class="btn ban-btn" data-ip="${visit.ip}" style="padding: 5px 10px;font-size: 0.9rem;">
                            <i class="fas fa-ban"></i> Ban
                        </button>
                    </td>`;
                visitsTableBody.appendChild(row);
            });
            
            // Add event listeners for ban buttons
            document.querySelectorAll('.ban-btn').forEach(btn => 
                btn.addEventListener('click', () => banIPFromVisit(btn.dataset.ip)));
        }

        // Ban IP from visit
        function banIPFromVisit(ip) {
            ipAddressInput.value = ip;
            banReasonInput.value = '';
            banIPModal.style.display = 'flex';
        }

        // Ban IP from log
        function banIPFromLog(ip) {
            ipAddressInput.value = ip;
            banReasonInput.value = '';
            banIPModal.style.display = 'flex';
        }

        // Drag and drop handlers
        function handleDragStart(e){
            draggedItem = this;
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', this.innerHTML);
            setTimeout(() => this.classList.add('dragging'), 0);
        }
        
        function handleDragOver(e){
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }
        
        function handleDragEnter(e){
            e.preventDefault();
            this.classList.add('drag-over');
        }
        
        function handleDragLeave(){
            this.classList.remove('drag-over');
        }
        
        function handleDrop(e){
            e.preventDefault();
            this.classList.remove('drag-over');
            
            if(draggedItem !== this){
                // Move the dragged item to the new position
                const allItems = Array.from(this.parentElement.children);
                const draggedIndex = allItems.indexOf(draggedItem);
                const targetIndex = allItems.indexOf(this);
                
                if(draggedIndex < targetIndex) {
                    this.parentNode.insertBefore(draggedItem, this.nextSibling);
                } else {
                    this.parentNode.insertBefore(draggedItem, this);
                }
                
                // Update positions in Firebase
                updateCameraPositions();
                updateNewsPositions();
                updateIPPositions();
            }
            
            return false;
        }
        
        function handleDragEnd(){
            this.classList.remove('dragging');
            document.querySelectorAll('.camera-card, .news-card, .ip-card').forEach(item => {
                item.classList.remove('drag-over');
            });
            draggedItem = null;
        }

        // Update camera positions after drag and drop
        function updateCameraPositions(){
            const updates = {};
            const cameraCards = cameraGrid.querySelectorAll('.camera-card');
            
            cameraCards.forEach((card, index) => {
                const cameraId = card.getAttribute('data-id');
                updates[`cameras/${cameraId}/position`] = index + 1;
            });
            
            database.ref().update(updates).then(() => {
                showNotification('Camera positions updated!');
                loadCameras();
            }).catch(err => {
                console.error(err);
                showNotification('Failed to update positions', true);
            });
        }

        // Update news positions after drag and drop
        function updateNewsPositions(){
            const updates = {};
            const newsCards = newsGrid.querySelectorAll('.news-card');
            
            newsCards.forEach((card, index) => {
                const newsId = card.getAttribute('data-id');
                updates[`news/${newsId}/position`] = index + 1;
            });
            
            database.ref().update(updates).then(() => {
                showNotification('News positions updated!');
                loadNews();
            }).catch(err => {
                console.error(err);
                showNotification('Failed to update positions', true);
            });
        }

        // Update IP positions after drag and drop
        function updateIPPositions(){
            const updates = {};
            const ipCards = ipGrid.querySelectorAll('.ip-card');
            
            ipCards.forEach((card, index) => {
                const banId = card.getAttribute('data-banid');
                updates[`banned_ips/${banId}/position`] = index + 1;
            });
            
            database.ref().update(updates).then(() => {
                showNotification('IP positions updated!');
                loadBannedIPs();
            }).catch(err => {
                console.error(err);
                showNotification('Failed to update positions', true);
            });
        }

        // Open add camera modal
        function openAddCameraModal(){
            currentEditingCameraId = null;
            document.getElementById('modalTitle').textContent = 'Add New Camera';
            cameraIdInput.value = '';
            cameraIdInput.disabled = false;
            englishTitleInput.value = '';
            chineseTitleInput.value = '';
            portugueseTitleInput.value = '';
            japaneseTitleInput.value = '';
            embedUrlInput.value = '';
            locationSelect.value = 'macau-city';
            positionInput.value = '';
            positionWarning.style.display = 'none';
            updatePositionExample();
            cameraModal.style.display = 'flex';
        }

        // Open add news modal
        function openAddNewsModal(){
            currentEditingNewsId = null;
            document.getElementById('newsModalTitle').textContent = 'Add New News';
            newsIdInput.value = '';
            newsIdInput.disabled = false;
            newsTitleInput.value = '';
            newsContentInput.value = '';
            newsCategorySelect.value = 'traffic';
            newsRowSelect.value = '1';
            newsPositionInput.value = '';
            newsModal.style.display = 'flex';
        }

        // Open ban IP modal
        function openBanIPModal(){
            ipAddressInput.value = '';
            banReasonInput.value = '';
            banIPModal.style.display = 'flex';
        }

        // Close ban IP modal
        function closeBanModalFunc(){
            banIPModal.style.display = 'none';
        }

        // Edit camera
        function editCamera(cameraId){
            currentEditingCameraId = cameraId;
            document.getElementById('modalTitle').textContent = 'Edit Camera';
            database.ref('cameras/' + cameraId).once('value').then(snapshot => {
                const camera = snapshot.val();
                if(camera){
                    cameraIdInput.value = cameraId;
                    cameraIdInput.disabled = true;
                    englishTitleInput.value = camera.titles.en;
                    chineseTitleInput.value = camera.titles.zh;
                    portugueseTitleInput.value = camera.titles.pt;
                    japaneseTitleInput.value = camera.titles.ja;
                    embedUrlInput.value = camera.embedUrl;
                    locationSelect.value = camera.location;
                    positionInput.value = camera.position || '';
                    positionWarning.style.display = 'none';
                    updatePositionExample();
                    validatePosition();
                    cameraModal.style.display = 'flex';
                }else{
                    showNotification('Camera not found', true);
                }
            }).catch(err => {
                console.error(err);
                showNotification('Failed to load camera', true);
            });
        }

        // Edit news
        function editNews(newsId){
            currentEditingNewsId = newsId;
            document.getElementById('newsModalTitle').textContent = 'Edit News';
            database.ref('news/' + newsId).once('value').then(snapshot => {
                const news = snapshot.val();
                if(news){
                    newsIdInput.value = newsId;
                    newsIdInput.disabled = true;
                    newsTitleInput.value = news.title;
                    newsContentInput.value = news.content;
                    newsCategorySelect.value = news.category;
                    newsRowSelect.value = news.row || '1';
                    newsPositionInput.value = news.position || '';
                    newsModal.style.display = 'flex';
                }else{
                    showNotification('News item not found', true);
                }
            }).catch(err => {
                console.error(err);
                showNotification('Failed to load news item', true);
            });
        }

        // Save camera
        function saveCamera() {
            const cameraId = cameraIdInput.value.trim();
            const englishTitle = englishTitleInput.value.trim();
            const chineseTitle = chineseTitleInput.value.trim();
            const portugueseTitle = portugueseTitleInput.value.trim();
            const japaneseTitle = japaneseTitleInput.value.trim();
            const embedUrl = embedUrlInput.value.trim();
            const location = locationSelect.value;
            const position = positionInput.value.trim();

            if (!cameraId || !englishTitle || !embedUrl) {
                showNotification('Please fill in all required fields', true);
                return;
            }

            // Create camera data object, ensure the position is set
            const cameraData = {
                titles: {
                    en: englishTitle,    
                    zh: chineseTitle,    
                    pt: portugueseTitle,    
                    ja: japaneseTitle
                },    
                embedUrl: embedUrl,    
                location: location,    
                position: position ? parseInt(position) : null // Convert to number
            };

            // Add/Update the camera
            database.ref(`cameras/${cameraId}`).set(cameraData)
                .then(() => {
                    showNotification(`Camera ${currentEditingCameraId ? 'updated' : 'added'} successfully!`);
                    cameraModal.style.display = 'none';
                    loadCameras(); // Reload to reflect new positions
                })
                .catch(err => {
                    console.error(err);
                    showNotification('Failed to save camera', true);
                });
        }

        // Save news
        function saveNews(){
            const newsId = newsIdInput.value.trim();
            const title = newsTitleInput.value.trim();
            const content = newsContentInput.value.trim();
            const category = newsCategorySelect.value;
            const row = newsRowSelect.value;
            const position = newsPositionInput.value.trim();
            
            if(!newsId || !title || !content){
                showNotification('Please fill in all required fields', true);
                return;
            }
            
            const newsData = {
                title: title,    
                content: content,    
                category: category,    
                row: row,    
                position: position ? parseInt(position) : null,    
                date: new Date().toISOString().split('T')[0] // Use date instead of timestamp
            };
            
            // Check for position conflicts
            let conflictNewsId = null;
            const positionNum = position ? parseInt(position) : null;
            
            if(positionNum){
                Object.keys(allNews).forEach(id => {
                    const news = allNews[id];
                    if(news.position === positionNum && id !== newsId)
                        conflictNewsId = id;
                });
            }
            
            if(conflictNewsId){
                // Move conflicting news to the end
                const newsInList = Object.values(allNews).filter(n => n.position !== null);
                const maxPosition = newsInList.length > 0 ? Math.max(...newsInList.map(n => n.position)) : 0;
                const newPositionForConflicting = maxPosition + 1;
                
                const updates = {};
                updates[`news/${conflictNewsId}/position`] = newPositionForConflicting;
                updates[`news/${newsId}`] = newsData;
                
                database.ref().update(updates)
                    .then(() => {
                        showNotification(`News saved! Moved conflicting item to position ${newPositionForConflicting}`);
                        newsModal.style.display = 'none';
                        loadNews();
                    })
                    .catch(err => {
                        console.error(err);
                        showNotification('Failed to save news', true);
                    });
            }else{
                database.ref('news/' + newsId).set(newsData)
                    .then(() => {
                        showNotification(`News ${currentEditingNewsId ? 'updated' : 'added'} successfully!`);
                        newsModal.style.display = 'none';
                        loadNews();
                    })
                    .catch(err => {
                        console.error(err);
                        showNotification('Failed to save news', true);
                    });
            }
        }

        // Ban IP address - FIXED FUNCTION
        function banIP(){
            const ip = ipAddressInput.value.trim();
            const reason = banReasonInput.value.trim();
            
            if(!ip){
                showNotification('Please enter an IP address', true);
                return;
            }
            
            // Generate a unique ban ID
            const banId = 'ban-' + Date.now();
            
            // Create ban data object with IP as sub-data
            const banData = {
                ip: ip,   
                reason: reason || 'No reason specified',   
                timestamp: new Date().toISOString()
            };
            
            // Save to Firebase with ban ID as the key
            database.ref(`banned_ips/${banId}`).set(banData)
                .then(() => {
                    showNotification(`IP ${ip} has been banned successfully with BAN ID: ${banId}!`);
                    banIPModal.style.display = 'none';
                    loadBannedIPs();
                    loadLoginLogs();
                })
                .catch(err => {
                    console.error(err);
                    showNotification('Failed to ban IP address', true);
                });
        }

        // Unban IP address using BAN ID
        function unbanIP(banId){
            if(confirm(`Are you sure you want to unban with BAN ID: ${banId}?`)){
                database.ref(`banned_ips/${banId}`).remove()
                    .then(() => {
                        showNotification(`BAN ID: ${banId} has been unbanned successfully!`);
                        loadBannedIPs();
                        loadLoginLogs();
                    })
                    .catch(err => {
                        console.error(err);
                        showNotification('Failed to unban', true);
                    });
            }
        }

        // Delete camera
        function deleteCamera(cameraId){
            if(confirm('Are you sure you want to delete this camera? This action cannot be undone.')){
                database.ref('cameras/' + cameraId).remove().then(() => {
                    showNotification('Camera deleted successfully!');
                    loadCameras();
                }).catch(err => {
                    console.error(err);
                    showNotification('Failed to delete camera', true);
                });
            }
        }

        // Delete news
        function deleteNews(newsId){
            if(confirm('Are you sure you want to delete this news item? This action cannot be undone.')){
                database.ref('news/' + newsId).remove().then(() => {
                    showNotification('News item deleted successfully!');
                    loadNews();
                }).catch(err => {
                    console.error(err);
                    showNotification('Failed to delete news item', true);
                });
            }
        }

        // Close modals
        function closeCameraModal(){
            cameraModal.style.display = 'none';
            cameraIdInput.disabled = false;
            suggestionList.style.display = 'none';
        }
        function closeNewsModalFunc(){
            newsModal.style.display = 'none';
            newsIdInput.disabled = false;
        }

        // Event Listeners
        loginBtn.addEventListener('click', login);
        addCameraBtn.addEventListener('click', openAddCameraModal);
        refreshBtn.addEventListener('click', loadCameras);
        logoutBtn.addEventListener('click', logout);
        saveCameraBtn.addEventListener('click', saveCamera);
        cancelBtn.addEventListener('click', closeCameraModal);
        closeModal.addEventListener('click', closeCameraModal);
        searchBtn.addEventListener('click', searchCamera);
        
        addNewsBtn.addEventListener('click', openAddNewsModal);
        refreshNewsBtn.addEventListener('click', loadNews);
        logoutNewsBtn.addEventListener('click', logout);
        saveNewsBtn.addEventListener('click', saveNews);
        cancelNewsBtn.addEventListener('click', closeNewsModalFunc);
        closeNewsModal.addEventListener('click', closeNewsModalFunc);
        searchNewsBtn.addEventListener('click', searchNews);
        
        banIPBtn.addEventListener('click', openBanIPModal);
        refreshIPBanBtn.addEventListener('click', () => {
            loadBannedIPs();
            loadLoginLogs();
        });
        logoutIPBanBtn.addEventListener('click', logout);
        saveBanBtn.addEventListener('click', banIP);
        cancelBanBtn.addEventListener('click', closeBanModalFunc);
        closeBanModal.addEventListener('click', closeBanModalFunc);
        
        refreshVisitsBtn.addEventListener('click', loadAllVisits);
        logoutVisitsBtn.addEventListener('click', logout);
        
        window.addEventListener('click', e => {
            if(e.target === cameraModal) closeCameraModal();
            if(e.target === newsModal) closeNewsModalFunc();
            if(e.target === banIPModal) closeBanModalFunc();
        });

        // Initialize the app
        init();
    </script>
</body>
</html>
